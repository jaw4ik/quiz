$(function(){function r(n){return decodeURI((RegExp(n+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}var f=r("courseId"),e=r("templateId"),i=location.protocol+"//"+location.host,u=i+"/api/course/"+f+"/template/"+e,o=1,n={enableXAPI:ko.observable(!1),lrsUrl:ko.observable(""),authenticationRequired:ko.observable(!1),lapLogin:ko.observable(),lapPassword:ko.observable(),isSaved:ko.observable(!1),isFailed:ko.observable(!1),logo:function(){var n={};return n.url=ko.observable("").extend({throttle:300}),n.hasLogo=ko.computed(function(){return n.url()!==""}),n.clear=function(){n.url("")},n.isError=ko.observable(!1),n.errorText=ko.observable(""),n.errorDescription=ko.observable(""),n.isLoading=ko.observable(!1),n}(),hasStarterPlan:ko.observable(!0),statements:{started:ko.observable(!0),stopped:ko.observable(!0),experienced:ko.observable(!0),mastered:ko.observable(!0),answered:ko.observable(!0),passed:ko.observable(!0),failed:ko.observable(!0)},masteryScore:ko.observable("")},t;n.credentialsEnabled=ko.computed(function(){return n.enableXAPI()&&n.authenticationRequired()});n.saveChanges=function(){var t={logo:{url:n.logo.url()},xApi:{enabled:n.enableXAPI(),lrs:{uri:n.lrsUrl(),authenticationRequired:n.authenticationRequired(),credentials:{username:n.lapLogin(),password:n.lapPassword()}},allowedVerbs:$.map(n.statements,function(n,t){return n()?t:undefined})},masteryScore:{score:n.masteryScore()}};n.isFailed(!1);n.isSaved(!1);$.post(u,{settings:JSON.stringify(t)}).done(function(){n.isSaved(!0)}).fail(function(){n.isFailed(!0)})};ko.bindingHandlers.fadeVisible={init:function(n,t){var i=t();$(n).toggle(ko.unwrap(i))},update:function(n,t){var i=t();ko.unwrap(i)?$(n).fadeIn():$(n).fadeOut()}};ko.bindingHandlers.number={init:function(n){var t=$(n),i=100;t.on("keydown",function(n){var t=n.charCode||n.keyCode||0;return t==8||t==9||t==46||t>=37&&t<=40||t>=48&&t<=57||t>=96&&t<=105});t.on("keyup",function(){$(this).val()>i&&$(this).val(i)})}};ko.bindingHandlers.disableDragNDrop={init:function(n){$(n).on("dragstart",function(n){n.preventDefault()})}};ko.bindingHandlers.spinner={init:function(n,t){var i=t();$(n).spinner("changed",function(n,t){i(t)})}};ko.applyBindings(n,$("#settingsForm")[0]);t={apiUrl:i+"/storage/image/upload",maxFileSize:10,supportedExtensions:["jpeg","jpg","png","bmp","gif"],somethingWentWrongMessage:{title:"Something went wrong",description:"Please, try again"},status:{"default":function(){n.logo.isLoading(!1);n.logo.isError(!1)},fail:function(t){n.logo.clear();n.logo.isLoading(!1);n.logo.errorText(t.title);n.logo.errorDescription(t.description);n.logo.isError(!0)},loading:function(){n.logo.isLoading(!0)}},button:{enable:function(){this.$input.attr("disabled",!1).closest(".image-upload-button").removeClass("disabled")},disable:function(){this.$input.attr("disabled",!0).closest(".image-upload-button").addClass("disabled")},submit:function(){this.$input[0].form.submit();this.disable();t.status.loading()},$input:$("#logoInput")},initFrame:function(){$("#logoForm").attr("action",t.apiUrl);$("#logoFrame").on("readystatechange",function(){if(this.readyState=="complete")try{var n=this.contentDocument.body.innerHTML;t.handleResponse(n)}catch(i){t.status.fail(t.somethingWentWrongMessage);t.button.enable()}})},init:function(){window.top.navigator.userAgent.match(/MSIE 9/i)&&t.initFrame();t.button.$input.on("change",t.processFile);t.button.enable()},processFile:function(){if(!this.files){t.button.submit();return}if(this.files.length!==0){var n=this.files[0],i=n.name.split(".").pop().toLowerCase();if($.inArray(i,t.supportedExtensions)===-1){t.status.fail({title:"Unsupported image format",description:"(Allowed formats: "+t.supportedExtensions.join(", ")+")"});return}if(n.size>t.maxFileSize*1048576){t.status.fail({title:"File is too large",description:"(Max file size: "+t.maxFileSize+"MB)"});return}t.uploadFile(n)}},uploadFile:function(n){t.button.disable();t.status.loading();var i=new FormData;i.append("file",n);$.ajax({url:t.apiUrl,type:"POST",data:i,cache:!1,dataType:"json",processData:!1,contentType:!1}).done(function(n){t.handleResponse(n)}).fail(function(){t.status.fail(t.somethingWentWrongMessage);t.button.enable()})},handleResponse:function(i){try{if(!i)throw"Response is empty";if(typeof i!="object"&&(i=JSON.parse(i)),!i||!i.success||!i.data)throw"Request is not success";n.logo.url(i.data.url);t.status.default()}catch(r){t.status.fail(t.somethingWentWrongMessage)}finally{t.button.enable()}}};$.ajax({cache:!1,url:u,dataType:"json",success:function(t){var i;try{i=JSON.parse(t)}catch(r){i={logo:{},xApi:{lrs:{credentials:{}}},masteryScore:{}}}n.enableXAPI(i.xApi.enabled||!1);n.lrsUrl(i.xApi.lrs.uri||"");n.authenticationRequired(i.xApi.lrs.authenticationRequired||!1);n.lapLogin(i.xApi.lrs.credentials.username||"");n.lapPassword(i.xApi.lrs.credentials.password||"");n.logo.url(i.logo.url||"");typeof i.masteryScore!="undefined"&&i.masteryScore.score>=0&&i.masteryScore.score<=100?n.masteryScore(i.masteryScore.score):n.masteryScore(100);i.xApi.allowedVerbs&&$.each(n.statements,function(n,t){t($.inArray(n,i.xApi.allowedVerbs)>-1)})},error:function(){n.masteryScore(100)}});$.ajax({url:i+"/api/identify",type:"POST",contentType:"application/json",dataType:"json",success:function(i){if(i.hasOwnProperty("subscription")&&i.subscription.hasOwnProperty("accessType")){var r=i.subscription.accessType>=o&&new Date(i.subscription.expirationDate)>=new Date;n.hasStarterPlan(r);r&&t.init()}else n.hasStarterPlan(!1)},error:function(){n.hasStarterPlan(!1)}})});